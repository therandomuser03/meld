// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
  PREFER_NOT_TO_SAY
  OTHER
}

enum LanguageLevel {
  NATIVE
  FLUENT
  INTERMEDIATE
  BASIC
}

enum UserLanguageType {
  READING
  WRITING
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

enum RoomRole {
  OWNER
  ADMIN
  MEMBER
}

enum ThreadType {
  DIRECT
  ROOM
}

enum ContentFormat {
  PLAIN
  MARKDOWN
  HTML
}

enum TranslationEntityType {
  MESSAGE
  NOTE
  TASK
  SNIPPET
}

enum NoteVisibility {
  PRIVATE
  ROOM
  SHARED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELED
}

model UserProfile {
  /// Supabase auth user id (uuid)
  id        String   @id @db.Uuid
  email     String   @unique
  name      String?
  avatarUrl String?

  profession String?
  bio        String?
  region     String? // e.g. "India", "Japan", "EU"
  countryCode String? @db.VarChar(2) // ISO-3166 alpha-2 (e.g. "IN")

  username    String? @unique
  gender Gender?

  /// Single primary reading locale for quick default translation (e.g. "en", "hi", "es")
  preferredReadingLocale String @default("en")

  /// Tracks if the user has completed the onboarding flow (profile + languages)
  isOnboarded Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Language preferences (multi-select)
  languages UserLanguage[]

  // Social
  sentConnectionRequests     ConnectionRequest[] @relation("SentRequests")
  receivedConnectionRequests ConnectionRequest[] @relation("ReceivedRequests")
  connectionsA Connection[] @relation("ConnectionA")
  connectionsB Connection[] @relation("ConnectionB")

  // Rooms
  roomsOwned Room[] @relation("RoomsOwned")
  roomMemberships RoomMember[]

  // Threads & messages
  threadsA Thread[] @relation("ThreadUserA")
  threadsB Thread[] @relation("ThreadUserB")
  messages Message[]

  // Content
  notes Note[]
  tasks Task[]

  // Translation cache created by user (optional ownership)
  translations Translation[]

  taskAssignees TaskAssignee[]

  // Shared notes (explicitly shared with me)
  sharedNotes Note[] @relation("SharedNotes")

  notifications Notification[]
}

model Language {
  id           String  @id @default(cuid())
  /// BCP-47 / common locale: "en", "en-US", "hi", "ja", "zh-Hans"
  locale       String  @unique
  nameEnglish  String
  nativeName   String?
  /// Helps show region-first languages (e.g. "IN", "JP")
  countryCode  String? @db.VarChar(2)
  /// Optional: script (Latn, Deva, Jpan, Hans, Hant)
  script       String?

  createdAt DateTime @default(now())

  userLinks UserLanguage[]
}

model UserLanguage {
  id        String @id @default(cuid())
  userId    String @db.Uuid
  languageId String

  type      UserLanguageType
  level     LanguageLevel?

  createdAt DateTime @default(now())

  user     UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  language Language    @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([userId, languageId, type])
  @@index([userId, type])
  @@index([languageId])
}

model ConnectionRequest {
  id        String @id @default(cuid())
  fromUserId String @db.Uuid
  toUserId   String @db.Uuid
  status    ConnectionStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromUser UserProfile @relation("SentRequests", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   UserProfile @relation("ReceivedRequests", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([toUserId, status])
  @@index([fromUserId, status])
}

model Connection {
  id      String @id @default(cuid())
  userAId String @db.Uuid
  userBId String @db.Uuid

  createdAt DateTime @default(now())

  userA UserProfile @relation("ConnectionA", fields: [userAId], references: [id], onDelete: Cascade)
  userB UserProfile @relation("ConnectionB", fields: [userBId], references: [id], onDelete: Cascade)

  /// Store pairs in canonical order in code (min,max) to enforce uniqueness
  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
}

model Room {
  id          String @id @default(cuid())
  name        String
  description String?
  ownerId     String @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner UserProfile @relation("RoomsOwned", fields: [ownerId], references: [id], onDelete: Cascade)

  members RoomMember[]
  thread  Thread? // room chat thread (optional but clean)

  notes Note[]
  tasks Task[]
}

model RoomMember {
  id      String @id @default(cuid())
  roomId  String
  userId  String @db.Uuid
  role    RoomRole @default(MEMBER)
  
  lastReadAt DateTime? @default(now())

  joinedAt DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([userId])
  @@index([roomId])
}

model Thread {
  id        String @id @default(cuid())
  type      ThreadType

  // DIRECT threads: userAId + userBId
  userAId   String? @db.Uuid
  userBId   String? @db.Uuid

  // ROOM threads: roomId
  roomId    String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userA UserProfile? @relation("ThreadUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB UserProfile? @relation("ThreadUserB", fields: [userBId], references: [id], onDelete: Cascade)

  room Room? @relation(fields: [roomId], references: [id], onDelete: Cascade)

  messages Message[]

  // last message helper
  lastMessageAt DateTime?
  
  // Read receipts for direct chats
  userALastReadAt DateTime? @default(now())
  userBLastReadAt DateTime? @default(now())

  @@index([type, lastMessageAt])
  @@index([userAId])
  @@index([userBId])
  @@index([roomId])
  // NOTE: canonical ordering for DIRECT enforced in code; use unique to prevent dup threads
  @@unique([type, userAId, userBId])
  @@unique([type, roomId])
}

model Message {
  id        String @id @default(cuid())
  threadId  String
  authorId  String @db.Uuid

  content   String
  format    ContentFormat @default(PLAIN)
  sourceLocale String? // optional if you want to store detected language

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author UserProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)

  translations Translation[] @relation("MessageTranslations")

  @@index([threadId, createdAt])
  @@index([authorId])
}

model Note {
  id        String @id @default(cuid())
  authorId  String @db.Uuid
  roomId    String?

  title     String
  body      String
  format    ContentFormat @default(MARKDOWN)
  sourceLocale String?

  visibility NoteVisibility @default(ROOM)

  tags      String[]

  pinned    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author UserProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)
  room   Room? @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Explicitly shared with specific users
  sharedWith UserProfile[] @relation("SharedNotes")

  translations Translation[] @relation("NoteTranslations")

  @@index([roomId, updatedAt])
  @@index([authorId, updatedAt])
}

model Task {
  id        String @id @default(cuid())
  authorId  String @db.Uuid
  roomId    String?

  title       String
  description String?
  status      TaskStatus @default(TODO)

  startDate   DateTime?
  endDate     DateTime? // Previously dueDate
  isAllDay    Boolean @default(false)
  priority    String? // HIGH, MEDIUM, LOW
  pinned    Boolean @default(false)

  sourceLocale String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author UserProfile @relation(fields: [authorId], references: [id], onDelete: Cascade)
  room   Room? @relation(fields: [roomId], references: [id], onDelete: Cascade)

  assignees TaskAssignee[]

  translations Translation[] @relation("TaskTranslations")

  @@index([roomId, status])
  @@index([authorId, status])
}

model TaskAssignee {
  id     String @id @default(cuid())
  taskId String
  userId String @db.Uuid

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId])
}

model Translation {
  id        String @id @default(cuid())

  entityType TranslationEntityType
  targetLocale String
  sourceLocale String?

  /// Store translated content (text/markdown/html). For "SNIPPET", this is the translated snippet.
  translatedContent String
  contentFormat ContentFormat @default(PLAIN)

  /// SHA-256 of `${contentFormat}:${originalContent}` OR `${contentFormat}:${snippetText}`
  contentHash String

  /// Optional pointers to original entity (one-of)
  messageId String?
  noteId    String?
  taskId    String?
  /// If translating arbitrary selected text:
  snippetText String?

  createdByUserId String? @db.Uuid

  createdAt DateTime @default(now())

  createdBy UserProfile? @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  message Message? @relation("MessageTranslations", fields: [messageId], references: [id], onDelete: Cascade)
  note    Note?    @relation("NoteTranslations", fields: [noteId], references: [id], onDelete: Cascade)
  task    Task?    @relation("TaskTranslations", fields: [taskId], references: [id], onDelete: Cascade)

  @@index([entityType, targetLocale])
  @@index([messageId])
  @@index([noteId])
  @@index([taskId])

  // Cache uniqueness per entity version:
  @@unique([entityType, messageId, targetLocale, contentHash])
  @@unique([entityType, noteId, targetLocale, contentHash])
  @@unique([entityType, taskId, targetLocale, contentHash])

  // For snippet translations (no entityId):
  @@unique([entityType, snippetText, targetLocale, contentHash])
}

model Notification {
  id        String @id @default(cuid())
  userId    String @db.Uuid

  title     String
  body      String?
  link      String?

  readAt    DateTime?
  createdAt DateTime @default(now())

  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
}
